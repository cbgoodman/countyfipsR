<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fuzzy Merging • countyfipsR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fuzzy Merging">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">countyfipsR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/using-countyfipsr.html">Using countyfipsR</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/fuzzy-merging.html">Fuzzy Merging</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cbgoodman/countyfipsR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Fuzzy Merging</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cbgoodman/countyfipsR/blob/master/vignettes/articles/fuzzy-merging.Rmd" class="external-link"><code>vignettes/articles/fuzzy-merging.Rmd</code></a></small>
      <div class="d-none name"><code>fuzzy-merging.Rmd</code></div>
    </div>

    
    
<p>Load in a sample of five counties.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cbgoodman/countyfipsR" class="external-link">countyfipsR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dgrtwo/fuzzyjoin" class="external-link">fuzzyjoin</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">countyfips_sample</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 7</span></span></span>
<span><span class="co">#&gt;   fips  county_name       state_name  state_abb state_fips county_fips county_ns</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 13145 Harris County     Georgia     GA        13         145            <span style="text-decoration: underline;">326</span>700</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 78030 St. Thomas Island U.S. Virgi… VI        78         030           2<span style="text-decoration: underline;">378</span>250</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 38053 Mckenzie County   North Dako… ND        38         053           1<span style="text-decoration: underline;">035</span>299</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 48045 Briscoe County    Texas       TX        48         045           1<span style="text-decoration: underline;">383</span>808</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 19147 Palo Alto County  Iowa        IA        19         147            <span style="text-decoration: underline;">465</span>262</span></span></code></pre></div>
<p>Perhaps one wants to merge in land and water areas by county;
however, you don’t have any numerical identifies to do this with. All
you have is an unclean text document with (bad) county names as the
identifier. The ‘county_name’ variable is correct in some instances,
missing parts of the name (county or a period), or entirely
misspelled.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">badmerge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="st">"county_name"</span>,        <span class="op">~</span><span class="st">"state_name"</span>,         <span class="op">~</span><span class="st">"aland"</span>,        <span class="op">~</span><span class="st">"awater"</span>,</span>
<span>  <span class="st">"Harris"</span>,              <span class="st">"Georgia"</span>,             <span class="fl">41201240346</span>,     <span class="fl">23711353</span>,</span>
<span>  <span class="st">"St Thomas Island"</span>,   <span class="st">"U.S. Virgin Islands"</span>,  <span class="fl">81108880</span>,        <span class="fl">717920922</span>,</span>
<span>  <span class="st">"Mckenzie County"</span>,     <span class="st">"North Dakota"</span>,        <span class="fl">7148712746</span>,      <span class="fl">260119355</span>,</span>
<span>  <span class="st">"Briscoe County"</span>,      <span class="st">"Texas"</span>,               <span class="fl">2330991073</span>,      <span class="fl">4068657</span>,</span>
<span>  <span class="st">"Pal Alto County"</span>,     <span class="st">"Iowa"</span>,                <span class="fl">1460400553</span>,      <span class="fl">14428727</span>,</span>
<span>  <span class="st">"Mineral County"</span>,      <span class="st">"Montana"</span>,             <span class="fl">3158799812</span>,      <span class="fl">9897218</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code>fuzzyjoin</code> package is perfect for this situation.</p>
<p>The <code>stringdist_left_join</code> command does the work. As an
aside, all the typical join methods are available by modifying the
‘inner’ portion of the command. You can also use a ‘mode’ option within
the command to specify the join method.</p>
<p>The choice of method is well beyond this article; however, they are
all the options available from the <code>stringdist</code> package.
Documentation can be found <a href="https://github.com/markvanderloo/stringdist" class="external-link">here</a> and more on
the various methods (theory mostly) can be found <a href="https://www.baeldung.com/cs/string-similarity-edit-distance" class="external-link">here</a>.
<code>method = "jw"</code> implements Jaro-Winkler distance, which
appears to be (to my untrained eye) the best character based matching
method.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">joined</span> <span class="op">&lt;-</span> <span class="va">countyfips_sample</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/fuzzyjoin/man/stringdist_join.html" class="external-link">stringdist_inner_join</a></span><span class="op">(</span></span>
<span>    <span class="va">badmerge</span>, </span>
<span>    by <span class="op">=</span> <span class="st">"county_name"</span>,   <span class="co">#match based on county_name</span></span>
<span>    method <span class="op">=</span> <span class="st">"jw"</span>,        <span class="co">#use jw distance metric</span></span>
<span>    max_dist <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>    distance_col <span class="op">=</span> <span class="st">"dist"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">county_name.x</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_min</a></span><span class="op">(</span>order_by<span class="op">=</span><span class="va">dist</span>, n<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">joined</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">fips</span>, <span class="va">county_name.x</span>, <span class="va">county_name.y</span>, <span class="va">dist</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   county_name.x [5]</span></span></span>
<span><span class="co">#&gt;   fips  county_name.x     county_name.y      dist</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 48045 Briscoe County    Briscoe County   0     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 13145 Harris County     Harris           0.179 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 38053 Mckenzie County   Mckenzie County  0     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 19147 Palo Alto County  Pal Alto County  0.110 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 78030 St. Thomas Island St Thomas Island 0.019<span style="text-decoration: underline;">6</span></span></span></code></pre></div>
<p>Here, <code>stringdist_inner_join</code> is attempting to match the
‘county_name’ string in ‘countyfips_sample’ with the same variable in
the ‘badmerge’ data. It’s doing so with the Jaro-Winkler distance method
with a max distance of 0.5 (JW = 0 for no matched string and JW = 1 for
exact matches; the choice of max distance is relatively arbitrary) and
saves that distance into column ‘dist’. Then, data are grouped by
counties we want to merge to and we select the group-row with the
smallest value of dist (or what <code>stringdist_inner_join</code>
believes to be the best match).</p>
<p>In this example, <code>stringdist_inner_join</code> does accurately
match the malformed data to our clean <code>countyfipsR</code> data. If
you want to see the other potential matches, exclude the
<code>slice_min</code> options to see the full range of matching
attempts.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">joined</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">county_name.y</span>, <span class="va">state_name.y</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    county_name <span class="op">=</span> <span class="va">county_name.x</span>, </span>
<span>    state_name <span class="op">=</span> <span class="va">state_name.x</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">fips</span>, <span class="va">county_name</span>, <span class="va">state_fips</span>, <span class="va">county_fips</span>, <span class="va">county_ns</span>, <span class="va">aland</span>, <span class="va">awater</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 7</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   county_name [5]</span></span></span>
<span><span class="co">#&gt;   fips  county_name       state_fips county_fips county_ns       aland    awater</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 48045 Briscoe County    48         045           1<span style="text-decoration: underline;">383</span>808  <span style="text-decoration: underline;">2</span>330<span style="text-decoration: underline;">991</span>073   4<span style="text-decoration: underline;">068</span>657</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 13145 Harris County     13         145            <span style="text-decoration: underline;">326</span>700 <span style="text-decoration: underline;">41</span>201<span style="text-decoration: underline;">240</span>346  23<span style="text-decoration: underline;">711</span>353</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 38053 Mckenzie County   38         053           1<span style="text-decoration: underline;">035</span>299  <span style="text-decoration: underline;">7</span>148<span style="text-decoration: underline;">712</span>746 260<span style="text-decoration: underline;">119</span>355</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 19147 Palo Alto County  19         147            <span style="text-decoration: underline;">465</span>262  <span style="text-decoration: underline;">1</span>460<span style="text-decoration: underline;">400</span>553  14<span style="text-decoration: underline;">428</span>727</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 78030 St. Thomas Island 78         030           2<span style="text-decoration: underline;">378</span>250    81<span style="text-decoration: underline;">108</span>880 717<span style="text-decoration: underline;">920</span>922</span></span></code></pre></div>
<p>Et voila, cleaned and merged data.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Chris Goodman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
